name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.5.0

permissions:
  contents: write  # Required for creating releases

jobs:
  build:
    name: Build Plugin Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          tools: composer:v2
      
      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Install Composer dependencies (production)
        run: composer install --no-dev --optimize-autoloader --no-interaction
      
      - name: Create release directory
        run: |
          mkdir -p release
          rsync -av --exclude='.git' \
                    --exclude='.github' \
                    --exclude='node_modules' \
                    --exclude='tests' \
                    --exclude='docs/planning' \
                    --exclude='docs/development' \
                    --exclude='docs/testing' \
                    --exclude='.gitignore' \
                    --exclude='.gitattributes' \
                    --exclude='composer.json' \
                    --exclude='composer.lock' \
                    --exclude='phpunit.xml' \
                    --exclude='phpunit.xml.dist' \
                    --exclude='pest.php' \
                    --exclude='docker-compose.yml' \
                    --exclude='Dockerfile' \
                    --exclude='.env.example' \
                    --exclude='release' \
                    . release/polytrans/
      
      - name: Create ZIP archives
        run: |
          cd release
          # Create version-specific ZIP for archival
          zip -r polytrans-${{ steps.version.outputs.VERSION }}.zip polytrans/
          # Create generic ZIP for easy WordPress installation
          zip -r polytrans.zip polytrans/
          cd ..
      
      - name: Generate checksums
        run: |
          cd release
          sha256sum polytrans-${{ steps.version.outputs.VERSION }}.zip > polytrans-${{ steps.version.outputs.VERSION }}.zip.sha256
          sha256sum polytrans.zip > polytrans.zip.sha256
          cd ..
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/polytrans.zip
            release/polytrans.zip.sha256
            release/polytrans-${{ steps.version.outputs.VERSION }}.zip
            release/polytrans-${{ steps.version.outputs.VERSION }}.zip.sha256
          body: |
            ## PolyTrans v${{ steps.version.outputs.VERSION }}
            
            ### üì¶ Installation
            
            **For WordPress Installation (Recommended):**
            1. Download `polytrans.zip` ‚¨ÖÔ∏è Use this one!
            2. Upload to WordPress via Plugins > Add New > Upload Plugin
            3. Activate the plugin
            
            **For Archival/Version Tracking:**
            - Download `polytrans-${{ steps.version.outputs.VERSION }}.zip` if you need version-specific archive
            
            **Note:** Both ZIPs contain identical files. The `polytrans.zip` ensures WordPress installs the plugin in the correct `polytrans/` directory (not `polytrans-1.5.0/`).
            
            ### ‚úÖ What's Included
            
            - All plugin files
            - Composer dependencies (vendor/)
            - Production-optimized autoloader
            
            ### üìã Changelog
            
            See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for full details.
            
            ### üîê Verification
            
            Verify the download integrity:
            ```bash
            # For WordPress installation:
            sha256sum -c polytrans.zip.sha256
            
            # For versioned archive:
            sha256sum -c polytrans-${{ steps.version.outputs.VERSION }}.zip.sha256
            ```
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload artifact for debugging
        uses: actions/upload-artifact@v4
        with:
          name: polytrans-${{ steps.version.outputs.VERSION }}
          path: release/polytrans.zip
          retention-days: 30

