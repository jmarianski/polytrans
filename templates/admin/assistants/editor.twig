{% set is_new = assistant.id == 0 %}
{% set current_provider = assistant.provider|default('openai') %}
{% set current_model = assistant.model|default('') %}

{# Note: Assets are enqueued in PHP before rendering this template #}

<div class="wrap">
    <h1>{{ is_new ? __('Add New Assistant', 'polytrans') : __('Edit Assistant', 'polytrans') }}</h1>

    <form id="assistant-editor-form" method="post">
        {{ wp_nonce_field('polytrans_assistant_save', 'assistant_nonce')|raw }}
        <input type="hidden" name="assistant_id" value="{{ assistant.id|esc_attr }}">

        <table class="form-table" role="presentation">
            <tbody>
                <tr>
                    <th scope="row">
                        <label for="assistant-name">{{ __('Name', 'polytrans') }} <span class="required">*</span></label>
                    </th>
                    <td>
                        <input type="text" id="assistant-name" name="name" class="regular-text" value="{{ assistant.name|esc_attr }}" required>
                        <p class="description">{{ __('A descriptive name for this assistant.', 'polytrans') }}</p>
                    </td>
                </tr>

                <tr>
                    <th scope="row">
                        <label for="assistant-provider">{{ __('Provider', 'polytrans') }} <span class="required">*</span></label>
                    </th>
                    <td>
                        <select id="assistant-provider" name="provider" required>
                            {% for provider_id, provider in available_assistant_providers %}
                                {% if provider %}
                                    <option value="{{ provider.id|esc_attr }}" {{ selected(assistant.provider|default('openai'), provider.id) }}>
                                        {{ provider.name|esc_html }}
                                    </option>
                                {% else %}
                                    <option value="{{ provider_id|esc_attr }}" disabled {{ selected(assistant.provider|default('openai'), provider_id) }}>
                                        {{ provider_id|capitalize|esc_html }} {{ __('(Not Available)', 'polytrans') }}
                                    </option>
                                {% endif %}
                            {% endfor %}
                        </select>
                        <p class="description">
                            {{ __('AI provider to use for this assistant. Only enabled providers with assistant support are shown.', 'polytrans') }}
                        </p>
                    </td>
                </tr>

                <tr>
                    <th scope="row">
                        <label for="assistant-model">{{ __('AI Model', 'polytrans') }}</label>
                    </th>
                    <td>
                        <select id="assistant-model" name="model" class="regular-text" data-selected-model="{{ current_model|esc_attr }}" data-provider="{{ current_provider|esc_attr }}">
                            {% set use_global_selected = current_model is empty ? 'selected' : '' %}
                            <option value="" {{ use_global_selected }}>{{ __('Use Global Setting', 'polytrans') }}</option>
                            {% for group_name, group_models in models %}
                                <optgroup label="{{ group_name|esc_attr }}">
                                    {% for model_value, model_label in group_models %}
                                        {% set model_selected = current_model == model_value ? 'selected' : '' %}
                                        <option value="{{ model_value|esc_attr }}" {{ model_selected }}>{{ model_label|esc_html }}</option>
                                    {% endfor %}
                                </optgroup>
                            {% endfor %}
                        </select>
                        <button type="button" id="refresh-models" class="button" style="margin-left: 0.5em;" title="{{ __('Refresh models from provider API', 'polytrans')|esc_attr }}">
                            {{ __('Refresh', 'polytrans') }}
                        </button>
                        <p class="description">{{ __('Select the AI model to use for this assistant. "Use Global Setting" will use the default model from plugin settings.', 'polytrans') }}</p>
                    </td>
                </tr>

                <tr id="system-prompt-row" class="system-prompt-field-row">
                    <th scope="row">
                        <label for="assistant-system-prompt">{{ __('System Instructions', 'polytrans') }} <span class="required system-prompt-required">*</span></label>
                    </th>
                    <td class="workflow-field-with-variables">
                        <div id="system-prompt-editor-container"></div>
                        <p class="description">{{ __('Instructions that define how the assistant should behave. This is static and doesn\'t change between requests.', 'polytrans') }}</p>
                        <p class="description"><strong>{{ __('Example:', 'polytrans') }}</strong> "You are a content quality expert. Analyze posts for grammar, SEO, and readability. Always respond in JSON format."</p>
                        <p class="description system-prompt-not-supported" style="display:none; color: #d63638;">
                            <strong>{{ __('Note:', 'polytrans') }}</strong> 
                            {{ __('This provider does not support system prompts. Only the User Message Template will be used.', 'polytrans') }}
                        </p>
                    </td>
                </tr>

                <tr>
                    <th scope="row">
                        <label for="assistant-user-message">{{ __('User Message Template', 'polytrans') }}</label>
                    </th>
                    <td class="workflow-field-with-variables">
                        <div id="user-message-editor-container"></div>
                        <p class="description">{{ __('Template for the user message with dynamic data. Use Twig syntax for variables: {{ variable_name }}', 'polytrans') }}</p>
                        <p class="description"><strong>{{ __('Example:', 'polytrans') }}</strong> "Title: {{ title }}\nContent: {{ content }}\n\nPlease analyze this content."</p>
                    </td>
                </tr>

                <tr>
                    <th scope="row">
                        <label for="assistant-response-format">{{ __('Response Format', 'polytrans') }}</label>
                    </th>
                    <td>
                        <select id="assistant-response-format" name="response_format">
                            <option value="text" {{ selected(assistant.response_format|default('text'), 'text') }}>{{ __('Text', 'polytrans') }}</option>
                            <option value="json" {{ selected(assistant.response_format|default('text'), 'json') }}>{{ __('JSON', 'polytrans') }}</option>
                        </select>
                        <p class="description">{{ __('Expected response format from the assistant.', 'polytrans') }}</p>
                    </td>
                </tr>
                <tr id="expected-output-schema-row" style="display: none;">
                    <th scope="row">
                        <label for="assistant-expected-output-schema">{{ __('Expected Output Schema', 'polytrans') }}</label>
                    </th>
                    <td>
                        <textarea id="assistant-expected-output-schema" name="expected_output_schema" class="large-text code" rows="8" placeholder='{"field_name": "type"}'>{{ expected_output_schema_json|textarea_safe }}</textarea>
                        <p class="description">
                            {{ __('Define the expected JSON structure for AI responses. Format: {"field": "type"}', 'polytrans') }}<br>
                            <strong>{{ __('Supported types:', 'polytrans') }}</strong> string, number, array, object, boolean<br>
                            <strong>{{ __('Example:', 'polytrans') }}</strong> {"title": "string", "content": "string", "meta": "object"}
                        </p>
                    </td>
                </tr>

                <tr>
                    <th scope="row">
                        <label for="assistant-temperature">{{ __('Temperature', 'polytrans') }}</label>
                    </th>
                    <td>
                        <input type="number" id="assistant-temperature" name="config[temperature]" class="small-text" min="0" max="2" step="0.1" value="{{ assistant.config.temperature|default(0.7)|esc_attr }}">
                        <p class="description">{{ __('Controls randomness: 0 = focused, 2 = creative. Default: 0.7', 'polytrans') }}</p>
                    </td>
                </tr>

            </tbody>
        </table>

        <div class="assistant-editor-actions">
            <button type="submit" class="button button-primary">
                {{ __('Save Assistant', 'polytrans') }}
            </button>
            <a href="{{ polytrans_admin_url('polytrans-assistants') }}" class="button">
                {{ __('Cancel', 'polytrans') }}
            </a>
        </div>
    </form>

</div>
