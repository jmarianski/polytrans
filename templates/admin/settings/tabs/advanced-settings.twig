{% set transport_mode = settings.translation_transport_mode|default('external') %}
{% set method = settings.translation_receiver_secret_method|default('header_bearer') %}

<h1>{{ __('Advanced Integration Settings', 'polytrans') }}</h1>

<h2>{{ __('Transport Mode', 'polytrans') }}</h2>
<select name="translation_transport_mode" id="translation-transport-mode" style="width:100%;max-width:400px;">
    <option value="external" {{ selected(transport_mode, 'external') }}>{{ __('External Server (Default)', 'polytrans') }}</option>
    <option value="internal" {{ selected(transport_mode, 'internal') }}>{{ __('Internal (Local Endpoint)', 'polytrans') }}</option>
</select>
<div style="margin-top:8px;">
    <small>
        {{ __('Choose how to handle translation transport:', 'polytrans') }}<br>
        <strong>{{ __('External Server:', 'polytrans') }}</strong> {{ __('Sends data to the external endpoints specified below and expects the server to send data back to the specified receiver endpoint.', 'polytrans') }}<br>
        <strong>{{ __('Internal:', 'polytrans') }}</strong> {{ __('Uses spawned processes to stay in the same server and achieve asynchronity.', 'polytrans') }}
    </small>
</div>

<div id="internal-mode-warning" class="notice notice-info inline" style="padding:10px;margin:16px 0 0 0;border-left-color:#72aee6;{{ transport_mode != 'internal' ? 'display:none;' : '' }}">
    <strong>{{ __('Note:', 'polytrans') }}</strong>
    {{ __('Internal mode uses non-blocking HTTP requests to trigger background processing. This may not work on all hosting environments (e.g., some shared hosts, environments without loopback connections, or servers with strict firewall rules). If translations are not processing, try switching to External mode with endpoints pointing to the same server.', 'polytrans') }}
</div>
<br><br>

{# ========== TRANSLATION SERVER ROLE ========== #}
{% set server_role = settings.translation_server_role|default('full') %}

<fieldset style="border:1px solid #c3c4c7;padding:16px 20px;margin-bottom:24px;">
<legend style="font-weight:600;padding:0 8px;">{{ __('Translation Server Role', 'polytrans') }}</legend>

<p style="margin-top:0;">
    <small>{{ __('Configure how this server handles incoming translation requests (when acting as a translation service for other sites).', 'polytrans') }}</small>
</p>

<select name="translation_server_role" id="translation-server-role" style="width:100%;max-width:400px;">
    <option value="full" {{ selected(server_role, 'full') }}>{{ __('Full Storage (Default)', 'polytrans') }}</option>
    <option value="translation_only" {{ selected(server_role, 'translation_only') }}>{{ __('Translation Only (Stateless)', 'polytrans') }}</option>
</select>
<div style="margin-top:8px;">
    <small>
        {{ __('Choose how this server processes incoming translation requests:', 'polytrans') }}<br>
        <strong>{{ __('Full Storage:', 'polytrans') }}</strong> {{ __('Creates posts locally, runs workflows, full processing. Use when this server also stores content.', 'polytrans') }}<br>
        <strong>{{ __('Translation Only:', 'polytrans') }}</strong> {{ __('Translates content and forwards to receiver without storing locally. No posts created, no workflows run. Ideal for dedicated translation servers.', 'polytrans') }}
    </small>
</div>

<div id="translation-only-warning" class="notice notice-info inline" style="padding:10px;margin:16px 0 0 0;border-left-color:#72aee6;{{ server_role != 'translation_only' ? 'display:none;' : '' }}">
    <strong>{{ __('Translation Only Mode:', 'polytrans') }}</strong>
    {{ __('In this mode, the "After workflows complete" dispatch option is ignored. Translations are always sent immediately after completion. Workflows configured on this server will not run for external translation requests.', 'polytrans') }}
</div>

</fieldset>

{# ========== EXTERNAL MODE SETTINGS ========== #}
<div id="external-mode-settings" style="{{ transport_mode != 'external' ? 'display:none;' : '' }}">

<fieldset style="border:1px solid #c3c4c7;padding:16px 20px;margin-bottom:24px;">
<legend style="font-weight:600;padding:0 8px;">{{ __('External Server Configuration', 'polytrans') }}</legend>

{% set received_workflow_mode = settings.received_translation_workflow_mode|default('run_workflows') %}
{% set outgoing_dispatch_mode = settings.outgoing_translation_dispatch_mode|default('immediate') %}
{% set after_workflows_cleanup = settings.after_workflows_cleanup_mode|default('delete') %}
{% set external_same_database = settings.external_same_database|default('no') %}

<h3>{{ __('Database Architecture', 'polytrans') }}</h3>
<select name="external_same_database" id="external-same-database" style="width:100%;max-width:400px;">
    <option value="no" {{ selected(external_same_database, 'no') }}>{{ __('Separate database (Default)', 'polytrans') }}</option>
    <option value="yes" {{ selected(external_same_database, 'yes') }}>{{ __('Same database as this site', 'polytrans') }}</option>
</select>
<div style="margin-top:8px;">
    <small>
        {{ __('Specify whether the external translation server shares the same database as this site:', 'polytrans') }}<br>
        <strong>{{ __('Separate database:', 'polytrans') }}</strong> {{ __('External server has its own database. Each server manages its own post status updates.', 'polytrans') }}<br>
        <strong>{{ __('Same database:', 'polytrans') }}</strong> {{ __('External server connects to the same database (e.g., separate WordPress for async processing). Prevents duplicate status updates.', 'polytrans') }}
    </small>
</div><br>

<div id="no-workflows-warning" class="notice notice-warning inline" style="display:none;padding:10px;margin:0 0 16px 0;">
    <strong>{{ __('Warning:', 'polytrans') }}</strong>
    {{ __('With current settings (Immediate dispatch + Trust external + Same database), post-processing workflows will NOT run anywhere. Consider using "After workflows complete" dispatch mode or enabling "Run workflows locally" on receiver.', 'polytrans') }}
</div>

<h3>{{ __('Received Translation Workflow Mode', 'polytrans') }}</h3>
<select name="received_translation_workflow_mode" id="received-workflow-mode" style="width:100%;max-width:400px;">
    <option value="run_workflows" {{ selected(received_workflow_mode, 'run_workflows') }}>{{ __('Run workflows locally (Default)', 'polytrans') }}</option>
    <option value="skip_workflows" {{ selected(received_workflow_mode, 'skip_workflows') }}>{{ __('Trust external server (skip local workflows)', 'polytrans') }}</option>
</select>
<div style="margin-top:8px;">
    <small>
        {{ __('Control whether workflows should run when receiving translations:', 'polytrans') }}<br>
        <strong>{{ __('Run workflows locally:', 'polytrans') }}</strong> {{ __('Execute configured post-processing workflows after receiving translation.', 'polytrans') }}<br>
        <strong>{{ __('Trust external server:', 'polytrans') }}</strong> {{ __('Assume the external server already ran workflows. Use with "After workflows complete" dispatch mode on sender.', 'polytrans') }}
    </small>
</div><br>

<h3>{{ __('Outgoing Translation Dispatch Mode', 'polytrans') }}</h3>
<select name="outgoing_translation_dispatch_mode" id="outgoing-dispatch-mode" style="width:100%;max-width:400px;">
    <option value="immediate" {{ selected(outgoing_dispatch_mode, 'immediate') }}>{{ __('Immediate (Default)', 'polytrans') }}</option>
    <option value="after_workflows" {{ selected(outgoing_dispatch_mode, 'after_workflows') }}>{{ __('After workflows complete', 'polytrans') }}</option>
</select>
<div style="margin-top:8px;">
    <small>
        {{ __('Control when translated content is dispatched to the target endpoint:', 'polytrans') }}<br>
        <strong>{{ __('Immediate:', 'polytrans') }}</strong> {{ __('Send translation to target endpoint immediately after translation completes.', 'polytrans') }}<br>
        <strong>{{ __('After workflows:', 'polytrans') }}</strong> {{ __('Run post-processing workflows on translator, then send processed content to target endpoint.', 'polytrans') }}
    </small>
</div><br>

<div id="after-workflows-cleanup-section" style="{{ outgoing_dispatch_mode != 'after_workflows' ? 'display:none;' : '' }}">
    <h3>{{ __('After Workflows: Local Post Cleanup', 'polytrans') }}</h3>
    <select name="after_workflows_cleanup_mode" style="width:100%;max-width:400px;">
        <option value="delete" {{ selected(after_workflows_cleanup, 'delete') }}>{{ __('Delete after dispatch (Default)', 'polytrans') }}</option>
        <option value="keep" {{ selected(after_workflows_cleanup, 'keep') }}>{{ __('Keep local post', 'polytrans') }}</option>
    </select>
    <div style="margin-top:8px;">
        <small>
            {{ __('Control what happens to the temporary local post after workflows complete and content is dispatched:', 'polytrans') }}<br>
            <strong>{{ __('Delete:', 'polytrans') }}</strong> {{ __('Remove the temporary post after dispatch (recommended for clean database).', 'polytrans') }}<br>
            <strong>{{ __('Keep:', 'polytrans') }}</strong> {{ __('Keep the local post. Useful for debugging or when external mode points to the same server.', 'polytrans') }}
        </small>
    </div><br>
</div>

</fieldset>

<fieldset style="border:1px solid #c3c4c7;padding:16px 20px;margin-bottom:24px;">
<legend style="font-weight:600;padding:0 8px;">{{ __('Endpoint Credentials', 'polytrans') }}</legend>

{% set endpoint_method = settings.translation_endpoint_secret_method|default('') %}
{% set receiver_method = settings.translation_receiver_secret_method|default('header_bearer') %}

<h3>{{ __('Translation Endpoint (Source → Translator)', 'polytrans') }}</h3>
<p><small>{{ __('Configure how this site connects to the external translation service.', 'polytrans') }}</small></p>

<h4>{{ __('Endpoint URL', 'polytrans') }}</h4>
<input type="url" name="translation_endpoint" value="{{ translation_endpoint|esc_attr }}" style="width:100%" placeholder="https://example.com/wp-json/polytrans/v1/translation/translate" />
<br><small>{{ __('URL of the external translation service endpoint.', 'polytrans') }}</small><br><br>

<h4>{{ __('Endpoint Secret', 'polytrans') }}</h4>
<div style="display:flex;gap:0.5em;align-items:center;max-width:600px;">
    <input type="text" id="translation-endpoint-secret" name="translation_endpoint_secret" value="{{ settings.translation_endpoint_secret|default('')|esc_attr }}" data-initial="{{ settings.translation_endpoint_secret|default('')|esc_attr }}" style="width:100%" placeholder="{{ __('Leave empty to use Receiver Secret', 'polytrans')|esc_attr }}" autocomplete="off" />
    <button type="button" class="button generate-secret-btn" data-target="translation-endpoint-secret" style="white-space:nowrap;">{{ __('Generate', 'polytrans') }}</button>
</div>
<br><small>{{ __('Secret for authenticating to the translation endpoint. If empty, uses the Receiver Secret below.', 'polytrans') }}</small><br><br>

<h4>{{ __('How to Pass Endpoint Secret', 'polytrans') }}</h4>
<select name="translation_endpoint_secret_method" id="translation-endpoint-secret-method" style="width:100%;max-width:400px;">
    <option value="" {{ selected(endpoint_method, '') }}>{{ __('Use Receiver method (default)', 'polytrans') }}</option>
    <option value="none" {{ selected(endpoint_method, 'none') }}>{{ __('None (do not send secret)', 'polytrans') }}</option>
    <option value="get_param" {{ selected(endpoint_method, 'get_param') }}>{{ __('GET parameter (?secret=...)', 'polytrans') }}</option>
    <option value="header_bearer" {{ selected(endpoint_method, 'header_bearer') }}>{{ __('HTTP Header: Authorization: Bearer ...', 'polytrans') }}</option>
    <option value="header_custom" {{ selected(endpoint_method, 'header_custom') }}>{{ __('HTTP Header: Custom Header Name', 'polytrans') }}</option>
    <option value="post_param" {{ selected(endpoint_method, 'post_param') }}>{{ __('POST body field (JSON: secret)', 'polytrans') }}</option>
</select><br><br>

<div id="endpoint-custom-header-section" style="{{ endpoint_method != 'header_custom' ? 'display:none;' : '' }}">
    <h4>{{ __('Endpoint Custom Header Name', 'polytrans') }}</h4>
    <input type="text" name="translation_endpoint_secret_custom_header" value="{{ settings.translation_endpoint_secret_custom_header|default('')|esc_attr }}" style="width:100%;max-width:400px;" placeholder="{{ __('Leave empty to use Receiver header', 'polytrans') }}" />
    <br><small>{{ __('Custom header name for endpoint authentication.', 'polytrans') }}</small><br><br>
</div>

<hr style="margin: 20px 0;">

<h3>{{ __('Receiver Endpoint (Translator → Target)', 'polytrans') }}</h3>
<p><small>{{ __('Configure where the translated content should be sent. These credentials are passed to the translator in the request payload.', 'polytrans') }}</small></p>

<h4>{{ __('Receiver URL', 'polytrans') }}</h4>
<input type="url" name="translation_receiver_endpoint" value="{{ translation_receiver_endpoint|esc_attr }}" style="width:100%" placeholder="https://example.com/wp-json/polytrans/v1/translation/receive-post" />
<br><small>{{ __('URL where translated content will be delivered. This is passed to the translator.', 'polytrans') }}</small><br><br>

<h4>{{ __('Receiver Secret', 'polytrans') }}</h4>
<div style="display:flex;gap:0.5em;align-items:center;max-width:600px;">
    <input type="text" id="translation-receiver-secret" name="translation_receiver_secret" value="{{ settings.translation_receiver_secret|default('')|esc_attr }}" data-initial="{{ settings.translation_receiver_secret|default('')|esc_attr }}" style="width:100%" placeholder="{{ __('Enter secret for receiver authentication', 'polytrans')|esc_attr }}" autocomplete="off" />
    <button type="button" class="button generate-secret-btn" data-target="translation-receiver-secret" style="white-space:nowrap;">{{ __('Generate', 'polytrans') }}</button>
</div>
<br><small>{{ __('Secret for authenticating to the receiver. Passed to the translator in the payload.', 'polytrans') }}</small><br><br>

<h4>{{ __('How to Pass Receiver Secret', 'polytrans') }}</h4>
<select name="translation_receiver_secret_method" id="translation-receiver-secret-method" style="width:100%;max-width:400px;">
    <option value="none" {{ selected(receiver_method, 'none') }}>{{ __('None (do not send secret)', 'polytrans') }}</option>
    <option value="get_param" {{ selected(receiver_method, 'get_param') }}>{{ __('GET parameter (?secret=...)', 'polytrans') }}</option>
    <option value="header_bearer" {{ selected(receiver_method, 'header_bearer') }}>{{ __('HTTP Header: Authorization: Bearer ...', 'polytrans') }}</option>
    <option value="header_custom" {{ selected(receiver_method, 'header_custom') }}>{{ __('HTTP Header: Custom Header Name', 'polytrans') }}</option>
    <option value="post_param" {{ selected(receiver_method, 'post_param') }}>{{ __('POST body field (JSON: secret)', 'polytrans') }}</option>
</select><br><br>

<div id="receiver-custom-header-section" style="{{ receiver_method != 'header_custom' ? 'display:none;' : '' }}">
    <h4>{{ __('Receiver Custom Header Name', 'polytrans') }}</h4>
    <input type="text" name="translation_receiver_secret_custom_header" value="{{ settings.translation_receiver_secret_custom_header|default('x-polytrans-secret')|esc_attr }}" style="width:100%;max-width:400px;" placeholder="x-polytrans-secret" />
    <br><small>{{ __('Specify the custom header name to use when sending the secret. Default is "x-polytrans-secret".', 'polytrans') }}</small><br><br>
</div>

</fieldset>

</div>
{# ========== END EXTERNAL MODE SETTINGS ========== #}

<h2>{{ __('Edit Link Base URL', 'polytrans') }}</h2>
<input type="url" name="edit_link_base_url" value="{{ settings.edit_link_base_url|default('')|esc_attr }}" style="width:100%" placeholder="https://example.com/wp-admin" />
<br><small>{{ __('Base URL for edit links in email notifications (e.g., https://example.com/wp-admin). If left empty, the system will attempt to use the default WordPress admin URL. This is useful when notifications are sent from background processes or external services that don\'t have proper WordPress context.', 'polytrans') }}</small><br><br>

<h2>{{ __('API Request Settings', 'polytrans') }}</h2>
<div class="translation-api-settings">
    {% set api_timeout = settings.api_timeout|default(180) %}
    <p>
        <label for="api-timeout"><strong>{{ __('API Request Timeout (seconds)', 'polytrans') }}</strong></label><br>
        <input type="number" id="api-timeout" name="api_timeout" value="{{ api_timeout|esc_attr }}" min="30" max="600" step="10" style="width:200px;" />
    </p>
    <small>
        {{ __('Timeout for AI provider API requests (OpenAI, Claude, Gemini). Default: 180 seconds (3 minutes). Increase this value if you experience timeout errors with long translations or complex workflows. The system will automatically retry once on timeout.', 'polytrans') }}
    </small>
</div><br>

<h2>{{ __('Logging Options', 'polytrans') }}</h2>
<div class="translation-logging-options">
    {% set enable_db_logging = settings.enable_db_logging|default(true) %}
    <p>
        <input type="checkbox" id="enable-db-logging" name="enable_db_logging" value="1" {{ checked(enable_db_logging) }}>
        <label for="enable-db-logging"><strong>{{ __('Enable Database Logging', 'polytrans') }}</strong></label>
    </p>
    <small>
        {{ __('When enabled, logs will be stored in the database table. When disabled, logs will only be written to the WordPress error log and post meta. Disabling database logging can improve performance and reduce database size, but makes viewing logs from the admin panel more limited. Warning: Logs from internal processes can only log to database, will never show up in stderr.', 'polytrans') }}
    </small>
</div><br>

<h2>{{ __('Dirty Check Field Whitelist', 'polytrans') }}</h2>
<div class="dirty-check-whitelist-options">
    <p>
        <textarea name="dirty_check_field_whitelist" id="dirty-check-field-whitelist" rows="6" style="width:100%;max-width:600px;font-family:monospace;">{{ settings.dirty_check_field_whitelist|default('')|esc_textarea }}</textarea>
    </p>
    <small>
        {{ __('Field name patterns to ignore when checking for unsaved changes (one pattern per line). Fields matching these patterns will not trigger the "Unsaved Changes" warning in the translation scheduler. This is useful for plugins that modify field values in the background.', 'polytrans') }}<br><br>
        <strong>{{ __('Built-in patterns (always active):', 'polytrans') }}</strong><br>
        <code>aioseo</code>, <code>yoast</code>, <code>wpseo</code>, <code>rank_math</code>, <code>seopress</code>, <code>tsf</code>, <code>acf-</code>, <code>woocommerce</code>, <code>elementor</code><br><br>
        <strong>{{ __('Example custom patterns:', 'polytrans') }}</strong><br>
        <code>my-custom-plugin</code><br>
        <code>jetpack</code><br>
        <code>wpforms</code>
    </small>
</div><br>

