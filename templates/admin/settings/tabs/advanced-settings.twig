{% set transport_mode = settings.translation_transport_mode|default('external') %}
{% set method = settings.translation_receiver_secret_method|default('header_bearer') %}

<h1>{{ __('Advanced Integration Settings', 'polytrans') }}</h1>

<h2>{{ __('Transport Options', 'polytrans') }}</h2>
<select name="translation_transport_mode" style="width:100%">
    <option value="external" {{ selected(transport_mode, 'external') }}>{{ __('External Server (Default)', 'polytrans') }}</option>
    <option value="internal" {{ selected(transport_mode, 'internal') }}>{{ __('Internal (Local Endpoint)', 'polytrans') }}</option>
</select>
<div style="margin-top:8px;">
    <small>
        {{ __('Choose how to handle translation transport:', 'polytrans') }}<br>
        <strong>{{ __('External Server:', 'polytrans') }}</strong> {{ __('Sends data to the external endpoints specified below and expects the server to send data back to the specified receiver endpoint.', 'polytrans') }}<br>
        <strong>{{ __('Internal:', 'polytrans') }}</strong> {{ __('Uses spawned processes to stay in the same server and achieve asynchronity. May not work in certain environments.', 'polytrans') }}
    </small>
</div><br><br>

{% set received_workflow_mode = settings.received_translation_workflow_mode|default('run_workflows') %}
{% set outgoing_dispatch_mode = settings.outgoing_translation_dispatch_mode|default('immediate') %}
{% set after_workflows_cleanup = settings.after_workflows_cleanup_mode|default('delete') %}
{% set external_same_database = settings.external_same_database|default('no') %}

<h2>{{ __('External Server Database', 'polytrans') }}</h2>
<select name="external_same_database" id="external-same-database" style="width:100%;max-width:400px;">
    <option value="no" {{ selected(external_same_database, 'no') }}>{{ __('Separate database (Default)', 'polytrans') }}</option>
    <option value="yes" {{ selected(external_same_database, 'yes') }}>{{ __('Same database as this site', 'polytrans') }}</option>
</select>
<div style="margin-top:8px;">
    <small>
        {{ __('Specify whether the external translation server shares the same database as this site:', 'polytrans') }}<br>
        <strong>{{ __('Separate database:', 'polytrans') }}</strong> {{ __('External server has its own database. Each server manages its own post status updates.', 'polytrans') }}<br>
        <strong>{{ __('Same database:', 'polytrans') }}</strong> {{ __('External server connects to the same database (e.g., separate WordPress for async processing). Prevents duplicate status updates.', 'polytrans') }}
    </small>
</div><br><br>

<div id="no-workflows-warning" class="notice notice-warning inline" style="display:none;padding:10px;margin:0 0 16px 0;">
    <strong>{{ __('Warning:', 'polytrans') }}</strong>
    {{ __('With current settings (Immediate dispatch + Skip workflows + Same database), post-processing workflows will NOT run anywhere. Consider using "After workflows complete" dispatch mode or "Run workflows" on receiver.', 'polytrans') }}
</div>

<h2>{{ __('Received Translation Workflow Mode', 'polytrans') }}</h2>
<select name="received_translation_workflow_mode" style="width:100%;max-width:400px;">
    <option value="run_workflows" {{ selected(received_workflow_mode, 'run_workflows') }}>{{ __('Run workflows (Default)', 'polytrans') }}</option>
    <option value="skip_workflows" {{ selected(received_workflow_mode, 'skip_workflows') }}>{{ __('Skip workflows (trust external)', 'polytrans') }}</option>
</select>
<div style="margin-top:8px;">
    <small>
        {{ __('Control whether workflows should run when receiving translations from external services:', 'polytrans') }}<br>
        <strong>{{ __('Run workflows:', 'polytrans') }}</strong> {{ __('Execute configured post-processing workflows after receiving translation.', 'polytrans') }}<br>
        <strong>{{ __('Skip workflows:', 'polytrans') }}</strong> {{ __('Trust the external translation service and skip local workflows.', 'polytrans') }}
    </small>
</div><br><br>

<h2>{{ __('Outgoing Translation Dispatch Mode', 'polytrans') }}</h2>
<select name="outgoing_translation_dispatch_mode" style="width:100%;max-width:400px;">
    <option value="immediate" {{ selected(outgoing_dispatch_mode, 'immediate') }}>{{ __('Immediate (Default)', 'polytrans') }}</option>
    <option value="after_workflows" {{ selected(outgoing_dispatch_mode, 'after_workflows') }}>{{ __('After workflows complete', 'polytrans') }}</option>
</select>
<div style="margin-top:8px;">
    <small>
        {{ __('Control when translated content is dispatched to the target endpoint:', 'polytrans') }}<br>
        <strong>{{ __('Immediate:', 'polytrans') }}</strong> {{ __('Send translation to target endpoint immediately after translation completes.', 'polytrans') }}<br>
        <strong>{{ __('After workflows:', 'polytrans') }}</strong> {{ __('Wait for all post-processing workflows to finish before sending to target endpoint.', 'polytrans') }}
    </small>
</div><br><br>

<div id="after-workflows-cleanup-section" style="{{ outgoing_dispatch_mode != 'after_workflows' ? 'display:none;' : '' }}">
    <h2>{{ __('After Workflows: Local Post Cleanup', 'polytrans') }}</h2>
    <select name="after_workflows_cleanup_mode" style="width:100%;max-width:400px;">
        <option value="delete" {{ selected(after_workflows_cleanup, 'delete') }}>{{ __('Delete after dispatch (Default)', 'polytrans') }}</option>
        <option value="keep" {{ selected(after_workflows_cleanup, 'keep') }}>{{ __('Keep local post', 'polytrans') }}</option>
    </select>
    <div style="margin-top:8px;">
        <small>
            {{ __('Control what happens to the temporary local post after workflows complete and content is dispatched:', 'polytrans') }}<br>
            <strong>{{ __('Delete:', 'polytrans') }}</strong> {{ __('Remove the temporary post after dispatch (recommended for clean database).', 'polytrans') }}<br>
            <strong>{{ __('Keep:', 'polytrans') }}</strong> {{ __('Keep the local post. Useful when using external mode internally.', 'polytrans') }}
        </small>
    </div><br><br>
</div>

{% set endpoint_method = settings.translation_endpoint_secret_method|default('') %}
{% set receiver_method = settings.translation_receiver_secret_method|default('header_bearer') %}

<h2>{{ __('Translation Endpoint (Source → Translator)', 'polytrans') }}</h2>
<p><small>{{ __('Configure how this site connects to the external translation service.', 'polytrans') }}</small></p>

<h3>{{ __('Endpoint URL', 'polytrans') }}</h3>
<input type="url" name="translation_endpoint" value="{{ translation_endpoint|esc_attr }}" style="width:100%" placeholder="https://example.com/wp-json/polytrans/v1/translation/translate" />
<br><small>{{ __('URL of the external translation service endpoint.', 'polytrans') }}</small><br><br>

<h3>{{ __('Endpoint Secret', 'polytrans') }}</h3>
<div style="display:flex;gap:0.5em;align-items:center;max-width:600px;">
    <input type="text" id="translation-endpoint-secret" name="translation_endpoint_secret" value="{{ settings.translation_endpoint_secret|default('')|esc_attr }}" data-initial="{{ settings.translation_endpoint_secret|default('')|esc_attr }}" style="width:100%" placeholder="{{ __('Leave empty to use Receiver Secret', 'polytrans')|esc_attr }}" autocomplete="off" />
    <button type="button" class="button generate-secret-btn" data-target="translation-endpoint-secret" style="white-space:nowrap;">{{ __('Generate', 'polytrans') }}</button>
</div>
<br><small>{{ __('Secret for authenticating to the translation endpoint. If empty, uses the Receiver Secret below.', 'polytrans') }}</small><br><br>

<h3>{{ __('How to Pass Endpoint Secret', 'polytrans') }}</h3>
<select name="translation_endpoint_secret_method" id="translation-endpoint-secret-method" style="width:100%;max-width:400px;">
    <option value="" {{ selected(endpoint_method, '') }}>{{ __('Use Receiver method (default)', 'polytrans') }}</option>
    <option value="none" {{ selected(endpoint_method, 'none') }}>{{ __('None (do not send secret)', 'polytrans') }}</option>
    <option value="get_param" {{ selected(endpoint_method, 'get_param') }}>{{ __('GET parameter (?secret=...)', 'polytrans') }}</option>
    <option value="header_bearer" {{ selected(endpoint_method, 'header_bearer') }}>{{ __('HTTP Header: Authorization: Bearer ...', 'polytrans') }}</option>
    <option value="header_custom" {{ selected(endpoint_method, 'header_custom') }}>{{ __('HTTP Header: Custom Header Name', 'polytrans') }}</option>
    <option value="post_param" {{ selected(endpoint_method, 'post_param') }}>{{ __('POST body field (JSON: secret)', 'polytrans') }}</option>
</select><br><br>

<div id="endpoint-custom-header-section" style="{{ endpoint_method != 'header_custom' ? 'display:none;' : '' }}">
    <h3>{{ __('Endpoint Custom Header Name', 'polytrans') }}</h3>
    <input type="text" name="translation_endpoint_secret_custom_header" value="{{ settings.translation_endpoint_secret_custom_header|default('')|esc_attr }}" style="width:100%;max-width:400px;" placeholder="{{ __('Leave empty to use Receiver header', 'polytrans') }}" />
    <br><small>{{ __('Custom header name for endpoint authentication.', 'polytrans') }}</small><br><br>
</div>

<hr style="margin: 24px 0;">

<h2>{{ __('Receiver Endpoint (Translator → Target)', 'polytrans') }}</h2>
<p><small>{{ __('Configure where the translated content should be sent. These credentials are passed to the translator in the request payload.', 'polytrans') }}</small></p>

<h3>{{ __('Receiver URL', 'polytrans') }}</h3>
<input type="url" name="translation_receiver_endpoint" value="{{ translation_receiver_endpoint|esc_attr }}" style="width:100%" placeholder="https://example.com/wp-json/polytrans/v1/translation/receive-post" />
<br><small>{{ __('URL where translated content will be delivered. This is passed to the translator.', 'polytrans') }}</small><br><br>

<h3>{{ __('Receiver Secret', 'polytrans') }}</h3>
<div style="display:flex;gap:0.5em;align-items:center;max-width:600px;">
    <input type="text" id="translation-receiver-secret" name="translation_receiver_secret" value="{{ settings.translation_receiver_secret|default('')|esc_attr }}" data-initial="{{ settings.translation_receiver_secret|default('')|esc_attr }}" style="width:100%" placeholder="{{ __('Enter secret for receiver authentication', 'polytrans')|esc_attr }}" autocomplete="off" />
    <button type="button" class="button generate-secret-btn" data-target="translation-receiver-secret" style="white-space:nowrap;">{{ __('Generate', 'polytrans') }}</button>
</div>
<br><small>{{ __('Secret for authenticating to the receiver. Passed to the translator in the payload.', 'polytrans') }}</small><br><br>

<h3>{{ __('How to Pass Receiver Secret', 'polytrans') }}</h3>
<select name="translation_receiver_secret_method" id="translation-receiver-secret-method" style="width:100%;max-width:400px;">
    <option value="none" {{ selected(receiver_method, 'none') }}>{{ __('None (do not send secret)', 'polytrans') }}</option>
    <option value="get_param" {{ selected(receiver_method, 'get_param') }}>{{ __('GET parameter (?secret=...)', 'polytrans') }}</option>
    <option value="header_bearer" {{ selected(receiver_method, 'header_bearer') }}>{{ __('HTTP Header: Authorization: Bearer ...', 'polytrans') }}</option>
    <option value="header_custom" {{ selected(receiver_method, 'header_custom') }}>{{ __('HTTP Header: Custom Header Name', 'polytrans') }}</option>
    <option value="post_param" {{ selected(receiver_method, 'post_param') }}>{{ __('POST body field (JSON: secret)', 'polytrans') }}</option>
</select><br><br>

<div id="receiver-custom-header-section" style="{{ receiver_method != 'header_custom' ? 'display:none;' : '' }}">
    <h3>{{ __('Receiver Custom Header Name', 'polytrans') }}</h3>
    <input type="text" name="translation_receiver_secret_custom_header" value="{{ settings.translation_receiver_secret_custom_header|default('x-polytrans-secret')|esc_attr }}" style="width:100%;max-width:400px;" placeholder="x-polytrans-secret" />
    <br><small>{{ __('Specify the custom header name to use when sending the secret. Default is "x-polytrans-secret".', 'polytrans') }}</small><br><br>
</div>

<h2>{{ __('Edit Link Base URL', 'polytrans') }}</h2>
<input type="url" name="edit_link_base_url" value="{{ settings.edit_link_base_url|default('')|esc_attr }}" style="width:100%" placeholder="https://example.com/wp-admin" />
<br><small>{{ __('Base URL for edit links in email notifications (e.g., https://example.com/wp-admin). If left empty, the system will attempt to use the default WordPress admin URL. This is useful when notifications are sent from background processes or external services that don\'t have proper WordPress context.', 'polytrans') }}</small><br><br>

<h2>{{ __('API Request Settings', 'polytrans') }}</h2>
<div class="translation-api-settings">
    {% set api_timeout = settings.api_timeout|default(180) %}
    <p>
        <label for="api-timeout"><strong>{{ __('API Request Timeout (seconds)', 'polytrans') }}</strong></label><br>
        <input type="number" id="api-timeout" name="api_timeout" value="{{ api_timeout|esc_attr }}" min="30" max="600" step="10" style="width:200px;" />
    </p>
    <small>
        {{ __('Timeout for AI provider API requests (OpenAI, Claude, Gemini). Default: 180 seconds (3 minutes). Increase this value if you experience timeout errors with long translations or complex workflows. The system will automatically retry once on timeout.', 'polytrans') }}
    </small>
</div><br>

<h2>{{ __('Logging Options', 'polytrans') }}</h2>
<div class="translation-logging-options">
    {% set enable_db_logging = settings.enable_db_logging|default(true) %}
    <p>
        <input type="checkbox" id="enable-db-logging" name="enable_db_logging" value="1" {{ checked(enable_db_logging) }}>
        <label for="enable-db-logging"><strong>{{ __('Enable Database Logging', 'polytrans') }}</strong></label>
    </p>
    <small>
        {{ __('When enabled, logs will be stored in the database table. When disabled, logs will only be written to the WordPress error log and post meta. Disabling database logging can improve performance and reduce database size, but makes viewing logs from the admin panel more limited. Warning: Logs from internal processes can only log to database, will never show up in stderr.', 'polytrans') }}
    </small>
</div><br>

<h2>{{ __('Dirty Check Field Whitelist', 'polytrans') }}</h2>
<div class="dirty-check-whitelist-options">
    <p>
        <textarea name="dirty_check_field_whitelist" id="dirty-check-field-whitelist" rows="6" style="width:100%;max-width:600px;font-family:monospace;">{{ settings.dirty_check_field_whitelist|default('')|esc_textarea }}</textarea>
    </p>
    <small>
        {{ __('Field name patterns to ignore when checking for unsaved changes (one pattern per line). Fields matching these patterns will not trigger the "Unsaved Changes" warning in the translation scheduler. This is useful for plugins that modify field values in the background.', 'polytrans') }}<br><br>
        <strong>{{ __('Built-in patterns (always active):', 'polytrans') }}</strong><br>
        <code>aioseo</code>, <code>yoast</code>, <code>wpseo</code>, <code>rank_math</code>, <code>seopress</code>, <code>tsf</code>, <code>acf-</code>, <code>woocommerce</code>, <code>elementor</code><br><br>
        <strong>{{ __('Example custom patterns:', 'polytrans') }}</strong><br>
        <code>my-custom-plugin</code><br>
        <code>jetpack</code><br>
        <code>wpforms</code>
    </small>
</div><br>

